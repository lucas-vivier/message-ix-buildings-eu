---
output: reprex::reprex_document
knit: reprex::reprex_render
---

Notebook to run STURM Ouput.

```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(stringr)

print(paste("Working directory is:", getwd()))

# Loding figures setttings and functions
source("STURM_output/C00_plots.R")

dir <- "simulation"
save_dir <- paste("STURM_output", "figures", dir, sep = "/")
file <- paste(save_dir, "results.csv", sep = "/")
data <- read.csv(file,  check.names = FALSE, stringsAsFactors = FALSE, header = TRUE, row.names = NULL)
data <- data[, -1]

emission_saving_counterfactual <- filter(data, scenario_name == "S1")$`Emission saving (%)`[1]
energy_saving_counterfactual <- filter(data, scenario_name == "S1")$`Consumption saving (%)`[1]
electricity_variation_counterfactual <- filter(data, scenario_name == "S1")$`Consumption electricity variation (%)`[1]

data <- data %>%
    mutate(color = "darkgrey") %>%
    mutate(size = 1) %>%
    mutate(`Emission saving (%)` = ifelse(scenario_name != "S1", `Emission saving (%)` + emission_saving_counterfactual, `Emission saving (%)`)) %>%
    mutate(`Consumption saving (%)` = ifelse(scenario_name != "S1", `Consumption saving (%)` + energy_saving_counterfactual, `Consumption saving (%)`)) %>%
    mutate(`Consumption electricity variation (%)` = ifelse(scenario_name != "S1", `Consumption electricity variation (%)` + electricity_variation_counterfactual, `Consumption electricity variation (%)`))

target_emission_saving <- 0.85
target_electricity_heating <- 1
# no social carbon price

data <- data %>%
    mutate(targets =
    `Emission saving (%)` >= target_emission_saving &
    carbon_tax != "social" &
    `Consumption electricity variation (%)` <= target_electricity_heating) %>%
    mutate(targets = ifelse(targets, "Constraint-Satisfying", "Constraint-Violating")) %>%
    mutate(targets = ifelse(scenario_name == "S1", "Counterfactual", targets))
```

##### Histogram - Distribution of key outcomes across scenarios
```{r}
source("STURM_output/C00_plots.R")

column <- "Consumption saving (%)"
save_path <- paste(save_dir, "Consumption_saving.png", sep = "/")
plot_histogram(data, column, save_path)

column <- "Emission saving (%)"
save_path <- paste(save_dir, "Emission_saving.png", sep = "/")
plot_histogram(data, column, save_path)

column <- "Consumption electricity variation (%)"
save_path <- paste(save_dir, "Electricity_variation.png", sep = "/")
plot_histogram(data, column, save_path)

column <- "Delta total cost private (euro/hh/year)"
save_path <- paste(save_dir, "Delta_total_cost_private_euro_hh_year.png", sep = "/")
plot_histogram(data, column, save_path)


# TODO: histogram cost-efficient strategies
```

##### Sobol - Identification of key policies
```{r}
# Sobol analysis
source("STURM_output/C00_plots.R")

rename_policies <- c("carbon_tax" = "Carbon tax",
    "sub_heat" = "Heat pump subsidies",
    "learning_rate_heat" = "Heat pump learning-by-doing",
    "_remove_barriers_heater" = "Market-failures heating system",
    "_objective_renovation" = "Energy renovation",
    "_realization_rate_renovation" = "Renovation realization rate",
    "_remove_barriers_renovation" = "Market-failures energy renovation")
list_policies <- c("carbon_tax", "_objective_renovation",
    "sub_heat", "learning_rate_heat", "_realization_rate_renovation",
    "_remove_barriers_renovation", "_remove_barriers_heater")
scenarios <- data %>%
    filter(!grepl("S1", scenario_name))


y <- "Emission cumulated (GtCO2)"
save_path <- paste(save_dir, "sobol_analysis_emission.png", sep = "/")
sobol_figures(scenarios, list_policies, y, rename_policies, save_path)

y <- "Space heating consumption (TWh)"
save_path <- paste(save_dir, "sobol_analysis_energy.png", sep = "/")
sobol_figures(scenarios, list_policies, y, rename_policies, save_path)

y <- "Delta total cost private (euro/hh/year)"
save_path <- paste(save_dir, "sobol_analysis_cost.png", sep = "/")
sobol_figures(scenarios, list_policies, y, rename_policies, save_path)

```


##### Scatter plot - Relationship between two key outcomes
```{r}
source("STURM_output/C00_plots.R")
x_column <- "Delta total cost private (euro/hh/year)"
y_column <- "Emission saving (%)"
color_column <- "targets"
size_column <- "size"

colors_scenarios <- c("Constraint-Violating" =  "darkgrey", "Constraint-Satisfying" = "darkgreen", "Counterfactual" = "black")
save_path <- paste(save_dir, "tradeoff_cost_emission.png", sep = "/")

temp <- data %>%
    mutate(`Emission saving (%)` = 100 * `Emission saving (%)`)

scatter_plots(temp,
            x_column,
            y_column,
            color_column,
            colors_scenarios = colors_scenarios,
            size_column,
            save_path = save_path,
            x_label_suffix = "",
            y_label_suffix = "%",
            legend_suffix = "",
            y_label = "Emission saving (%)",
            x_label = "Cost (â‚¬/hh/year)",
            legend = TRUE,
            presentation = FALSE)

```

```{r}
source("STURM_output/C00_plots.R")

x_column <- "Consumption electricity variation (%)"
y_column <- "Emission saving (%)"
color_column <- "targets"
size_column <- "size"

colors_scenarios <- c("Constraint-Violating" =  "darkgrey", "Constraint-Satisfying" = "darkgreen", "Counterfactual" = "black")
save_path <- paste(save_dir, "tradeoff_eletricity_emission.png", sep = "/")

temp <- data %>%
    mutate(`Consumption electricity variation (%)` = 100 * `Consumption electricity variation (%)`) %>%
    mutate(`Emission saving (%)` = 100 * `Emission saving (%)`)

scatter_plots(temp,
            x_column,
            y_column,
            color_column,
            colors_scenarios = colors_scenarios,
            size_column,
            save_path = save_path,
            x_label_suffix = "%",
            y_label_suffix = "%",
            legend_suffix = "",
            y_label = "Emission saving (%)",
            x_label = "Consumption electricity variation (%)",
            legend = TRUE,
            presentation = FALSE)


```

#### Identification of policies that are in the target
```{r}
# Identify the policies that are in the target


rename_policies <- c("carbon_tax" = "Carbon tax",
    "sub_heat" = "Heat pump subsidies",
    "learning_rate_heat" = "Heat pump learning-by-doing",
    "_remove_barriers_heater" = "Policies tackling market-failures heating system",
    "_objective_renovation" = "Energy renovation subsidies",
    "_realization_rate_renovation" = "Renovation realization rate",
    "_remove_barriers_renovation" = "Market-failures energy renovation")

list_policies <- c("carbon_tax", "_objective_renovation",
    "sub_heat", "learning_rate_heat", "_realization_rate_renovation",
    "_remove_barriers_renovation", "_remove_barriers_heater")

temp <- data %>%
    filter(targets == "Constraint-Satisfying") %>%
    select(all_of(list_policies)) %>%
    mutate(across(all_of(list_policies), as.character)) %>%
    pivot_longer(cols = all_of(list_policies),
                names_to = "policy", 
                values_to = "value") %>%
    # replace "" by "No"
    mutate(value = ifelse(value == "", "No", value))

# Add a count column for position adjustment
n_scenario <- nrow(temp)
temp <- temp %>%
  group_by(policy, value) %>%
  summarise(count = n()) #/ n_scenario)



# Make stacked bar plot of the policies in the target scenarios
p <- temp %>%
    mutate(policy = rename_policies[policy]) %>%
    ggplot(aes(y = policy, fill = value)) +
    geom_bar(position = "fill") +
    geom_text(aes(label = value, x = 1), 
            position = position_fill(vjust = 0.5), 
            size = 6, 
            color = "white") +
    message_building_theme +
    # No legend
    theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none")

save_path <- paste(save_dir, "policies_condition.png", sep = "/")
ggsave(save_path, plot = p, width = plot_settings[["width"]],
        height = plot_settings[["height"]],
        dpi = plot_settings[["dpi"]])

``` 

#------------------------------------------------------------------------------
#### Analysis by countries

```{r}


file <- "STURM_data/input_csv/input_resid/decision/cost_factor_countries_EU.csv"
cost_factor <- read.csv(file,  check.names = FALSE, stringsAsFactors = FALSE, header = TRUE, row.names = NULL) %>%
    mutate(region_bld = rename_countries[region_bld]) %>%
    rename(name = region_bld, cost_factor = value)


file <- "2024-06-10_131316_2050_summary_countries.csv"
file <- paste(save_dir, file, sep = "/")
data_eu <- read.csv(file,  check.names = FALSE, stringsAsFactors = FALSE, header = TRUE, row.names = NULL) %>%
    mutate(name = `Member states`) %>%
    # Normalize the cost factor
    left_join(cost_factor) %>%
    mutate(cost_factor = ifelse(is.na(cost_factor), 1, cost_factor)) %>%
    mutate(
        `Cost renovation (Billion EUR)` = `Cost renovation (Billion EUR)` / cost_factor,
        `Cost heater (Billion EUR)` = `Cost heater (Billion EUR)` / cost_factor,
        `Total cost (Billion EUR)` = `Total cost (Billion EUR)` / cost_factor,
        `Government expenditures (Billion EUR)` = `Government expenditures (Billion EUR)` / cost_factor
        ) %>%
    # Add per capita values
    mutate(
        `Space heating consumption (MWh/capita)` = `Space heating consumption (TWh)` / `Population (Million)`,
        `Emission (tCO2/capita)` = `Emission (MtCO2)` / `Population (Million)`,
        `Cost renovation (EUR/capita)` = `Cost renovation (Billion EUR)` / `Population (Million)`,
        `Cost heater (EUR/capita)` = `Cost heater (Billion EUR)` / `Population (Million)`,
        `Government expenditures (Billion EUR)` = `Government expenditures (Billion EUR)` / `Population (Million)`,
    ) %>%
    mutate(name = ifelse(name == "Czech Republic", "Czechia", name))



scenarios_target <- filter(data, targets == "Constraint-Satisfying")$scenario_name
best_scenario <- data %>%
    filter(targets == "Constraint-Satisfying") %>%
    # Get the scenario that minimize the cost
    filter(`Delta total cost (euro/hh/year)` == min(`Delta total cost (euro/hh/year)`))
best_scenario <- best_scenario$scenario_name

```

```{r}
# Calculate the cost


temp <- data_eu %>%
    filter(scenario_name %in% scenarios_target) %>%
    group_by_at("Member states") %>%
    summarize(`Emission saving (%)` = mean(`Emission saving (%)`),
        `Consumption saving (%)` = mean(`Consumption saving (%)`),
        `Consumption electricity variation (%)` = mean(`Consumption electricity variation (%)`),
        `Renovated buildings (#/capita)` = mean(`Renovated buildings (Million)` / `Population (Million)`),
        `Heat-pumps (#/capita)` = mean(`Heat-pumps (Million)` / `Population (Million)`),
        `Space heating consumption (MWh/capita)` = mean(`Space heating consumption (TWh)` / `Population (Million)`),
        `Emission (tCO2/capita)` = mean(`Emission (MtCO2)` / `Population (Million)`),
        `Government expenditures (EUR/capita)`= mean(`Government expenditures (Billion EUR)` / `Population (Million)`),
        `Cost renovation (EUR/capita)` = mean(`Cost renovation (Billion EUR)` / `Population (Million)`),
        `Cost heater (EUR/capita)` = mean(`Cost heater (Billion EUR)` / `Population (Million)`),
        `Total cost (EUR/capita)`= mean(`Total cost (Billion EUR)` / `Population (Million)`))


write.csv(temp, paste(save_dir, "scenario_target_countries.csv", sep = "/"), row.names = FALSE)

```

###### Maps

```{r}
# Check energy consumption per capita in Initial, Counterfactual and Ambitious scenario

df <- data_eu %>%
    filter(scenario_name %in% c("Initial", "S1", best_scenario)) %>%
    mutate(`Space heating consumption (MWh/capita)` = `Space heating consumption (TWh)` / `Population (Million)`) %>%
    mutate(`Emission (tCO2/capita)` = `Emission (MtCO2)` / `Population (Million)`) %>%
    mutate(name = `Member states`) %>%
    mutate(scenario_name = ifelse(scenario_name == "S1", "Counterfactual", scenario_name)) %>%
    mutate(scenario_name = ifelse(scenario_name == best_scenario, "Ambitious", scenario_name))
```

```{r}
source("STURM_output/C00_plots.R")

temp <- df %>%
    select(c("scenario_name", "name", "Space heating consumption (MWh/capita)")) %>%
    rename(value = `Space heating consumption (MWh/capita)`)

scenario_order <- c("Initial", "Counterfactual", "Ambitious")
temp$scenario_name <- factor(temp$scenario_name, levels = scenario_order)

limits <- c(0, 7)
save_path <- paste(save_dir, "space_heating_consumption_countries.png", sep = "/")

plot_map(temp,
        limits,
        figure_title = "",
        save_path = save_path,
        legend_title = "MWh/capita",
        subplot_column = "scenario_name",
        ncol = 3,
        key = "name")
```

```{r}
source("STURM_output/C00_plots.R")

temp <- df %>%
    select(c("scenario_name", "name", "Share fossil-fuels (Percent)")) %>%
    rename(value = `Share fossil-fuels (Percent)`) %>%
    mutate(value = ifelse(is.na(value), 0, value))

scenario_order <- c("Initial", "Counterfactual", "Ambitious")
temp$scenario_name <- factor(temp$scenario_name, levels = scenario_order)

limits <- c(0, 0.8)
save_path <- paste(save_dir, "share_fossil_fuels_countries.png", sep = "/")

plot_map(temp,
        limits,
        figure_title = "",
        save_path = save_path,
        legend_title = "%",
        subplot_column = "scenario_name",
        ncol = 3,
        key = "name")
```

### Calculate difference compared to the S1 the counterfactual
```{r}

rename_variable <- c("Space heating consumption (TWh)" = "Energy consumption",
    "Emission (MtCO2)" = "Emission",
    "Cost renovation (Billion EUR)" = "Renovation investment",
    "Cost heater (Billion EUR)" = "Heating system investment")

variables <- c("Space heating consumption (TWh)", "Emission (MtCO2)")#, "Cost renovation (Billion EUR)", "Cost heater (Billion EUR)")
diff_counterfactual_eu <- data_eu %>%
    filter(scenario_name %in% c("S1", best_scenario)) %>%
    select(all_of(c("scenario_name", "name", variables))) %>%
    pivot_longer(cols = all_of(variables),
                names_to = "variable",
                values_to = "value") %>%
    pivot_wider(names_from = "scenario_name", values_from = "value") %>%
    mutate(value = (.data[[best_scenario]] - .data[["S1"]]) / .data[["S1"]]) %>%
    mutate(variable = rename_variable[variable])
```

```{r}
limits <- c(-1, 0)
save_path <- paste(save_dir, "effort_countries.png", sep = "/")

plot_map(diff_counterfactual_eu,
        limits,
        figure_title = "",
        save_path = save_path,
        legend_title = "%",
        subplot_column = "variable",
        ncol = 4,
        key = "name")
```



```{r}
rename_variable <- c("Emission saving (%)" = "Emission saving",
    "Consumption saving (%)" = "Emission",
    "Cost renovation (Billion EUR)" = "Renovation investment",
    "Cost heater (Billion EUR)" = "Heating system investment")

variables <- c("Emission saving (%)", "Consumption saving (%)", "Consumption electricity variation (%)")
diff_avg_eu <- data_eu %>%
    filter(scenario_name == best_scenario) %>%
    select(all_of(c("name", variables))) %>%
    pivot_longer(cols = all_of(variables),
                names_to = "variable",
                values_to = "value") %>%
    group_by(variable) %>%
    mutate(average = mean(value)) %>%
    ungroup() %>%
    # Compare to average value accross countries
    mutate(value = (.data[[best_scenario]] - .data[[best_scenario]]) / .data[[best_scenario]]) %>%
    mutate(value = (.data[[best_scenario]] - .data[["S1"]]) / .data[["S1"]]) %>%
    mutate(variable = rename_variable[variable])


```

```{r}


```


### Calculate difference compared to the S1 the counterfactual
```{r}

rename_variable <- c("Space heating consumption (MWh/capita)" = "Energy reduction effort",
    "Emission (tCO2/capita)" = "Emission reduction effort",
    "Cost renovation (EUR/capita)" = "Cost renovation effort",
    "Cost heater (EUR/capita)" = "Cost heater effort")

variables <- c("Space heating consumption (MWh/capita)", "Emission (tCO2/capita)",
    "Cost renovation (EUR/capita)", "Cost heater (EUR/capita)")#, "Cost renovation (Billion EUR)", "Cost heater (Billion EUR)")
diff_counterfactual_eu <- data_eu %>%
    filter(scenario_name %in% c("S1", best_scenario)) %>%
    select(all_of(c("scenario_name", "name", variables))) %>%
    pivot_longer(cols = all_of(variables),
                names_to = "variable",
                values_to = "value") %>%
    pivot_wider(names_from = "scenario_name", values_from = "value") %>%
    mutate(effort = (.data[[best_scenario]] - .data[["S1"]])) %>%
    group_by(variable) %>%
    mutate(avg_effort = mean(effort)) %>%
    ungroup() %>%
    mutate(value = effort / avg_effort) %>%
    mutate(variable = ifelse(variable %in% names(rename_variable), rename_variable[variable], variable))
```

```{r}
limits <- c(-2, 2)
save_path <- paste(save_dir, "effort_countries.png", sep = "/")

plot_map(diff_counterfactual_eu,
        limits,
        figure_title = "",
        save_path = save_path,
        legend_title = "Effort compared to average",
        subplot_column = "variable",
        ncol = 2,
        key = "name")

```